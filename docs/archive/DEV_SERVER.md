# 開発サーバー管理ガイド

## 概要

このプロジェクトでは、開発サーバーのプロセス管理を改善するため、専用のスクリプトを用意しています。
これにより、サーバーの起動・停止・クリーンアップが確実に行えます。

## 問題の背景

`npm run dev` で起動したNext.jsサーバーが、接続が切れた後もバックグラウンドで動作し続け、
手動で `lsof -i :3000` と `kill` コマンドを使ってプロセスを終了する必要がありました。

この問題を解決するため、PIDファイルを使用したプロセス管理システムを実装しました。

## 使用方法

### 開発サーバーの起動

```bash
npm run dev
```

このコマンドは `scripts/dev-server.sh` を実行し、以下の処理を行います：

1. 既存のサーバーが起動中かチェック
2. ポート3000が使用中の場合、既存プロセスを終了
3. Next.js開発サーバーを起動
4. プロセスIDを `.dev-server.pid` ファイルに保存
5. Ctrl+Cでのグレースフルシャットダウンに対応

### 開発サーバーの停止

#### 方法1: Ctrl+C（推奨）

サーバーを起動したターミナルで `Ctrl+C` を押すと、グレースフルにシャットダウンします。

#### 方法2: 別のターミナルから停止

```bash
npm run stop
```

このコマンドは `scripts/stop-dev.sh` を実行し、以下の処理を行います：

1. `.dev-server.pid` ファイルからプロセスIDを読み込み
2. プロセスに終了シグナルを送信
3. 10秒待機してもプロセスが終了しない場合、強制終了
4. PIDファイルを削除

### 孤立プロセスのクリーンアップ

何らかの理由でプロセスが残ってしまった場合：

```bash
npm run cleanup
```

このコマンドは `scripts/cleanup-dev.sh` を実行し、以下の処理を行います：

1. ポート3000を使用している全プロセスを検索
2. 見つかったプロセスの情報を表示
3. 確認後、プロセスを終了
4. 古いPIDファイルがあれば削除

## トラブルシューティング

### サーバーが起動しない

**エラー**: "Development server is already running"

**解決方法**:
```bash
npm run stop
# または
npm run cleanup
```

### ポートが使用中

**エラー**: "Port 3000 is already in use"

開発サーバースクリプトは自動的に既存プロセスを終了しますが、
それでも問題がある場合：

```bash
npm run cleanup
```

### PIDファイルが残っている

サーバーが異常終了した場合、`.dev-server.pid` ファイルが残ることがあります。
これは `npm run stop` または `npm run cleanup` で自動的に削除されます。

手動で削除する場合：
```bash
rm .dev-server.pid
```

## スクリプトファイル

- `scripts/dev-server.sh` - 開発サーバー起動スクリプト
- `scripts/stop-dev.sh` - 開発サーバー停止スクリプト
- `scripts/cleanup-dev.sh` - 孤立プロセスクリーンアップスクリプト

## 注意事項

- `.dev-server.pid` ファイルは `.gitignore` に追加されており、Gitでは管理されません
- スクリプトはmacOS/Linuxで動作します（Windowsでは動作しません）
- 複数の開発サーバーを同時に起動することはできません

## 従来の方法との比較

### 従来の方法
```bash
# 起動
npm run dev

# 停止（手動でプロセスを探す必要があった）
lsof -i :3000
kill <PID>
```

### 新しい方法
```bash
# 起動
npm run dev

# 停止（自動的にプロセスを見つけて終了）
Ctrl+C
# または
npm run stop

# クリーンアップ（孤立プロセスを一括削除）
npm run cleanup
```
